// Prisma schema for Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CrewMember {
  id              String   @id @default(cuid())
  employeeCode    String?  @unique
  firstName       String?
  lastName        String?
  fullName        String?
  rank            String?
  position        String?
  department      String?
  nationality     String?
  passportNumber  String?
  passportExpiry  DateTime?
  email           String?
  phone           String?
  status          String   @default("ACTIVE")
  rawData         Json?    // Store all original Excel columns
  importId        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  import          CrewImport? @relation(fields: [importId], references: [id])
  ticketFlights   TicketFlight[]

  @@index([employeeCode])
  @@index([status])
}

model CrewImport {
  id          String        @id @default(cuid())
  filename    String
  rowCount    Int
  headers     Json
  uploadedAt  DateTime      @default(now())
  members     CrewMember[]

  @@index([uploadedAt])
}

// Ticketing upload dosyaları için modeller
// Kullanıcı sadece son iki yüklemeyi karşılaştırır: yeni yükleme geldiğinde en eski kayıt silinir.
model TicketUpload {
  id         String        @id @default(cuid())
  filename   String
  uploadedAt DateTime      @default(now())
  headers    Json
  flights    TicketFlight[]
}

// Her satır bir uçuş + ilgili tek bir ekip satırını temsil eder (excel satırı)
// Aynı Pairing Route + aynı kalkış tarih-saat + airline + flightNumber bir uçuş grubunu ifade eder
model TicketFlight {
  id            String        @id @default(cuid())
  uploadId      String
  upload        TicketUpload  @relation(fields: [uploadId], references: [id])
  pairingRoute  String?
  flightNumber  String?
  airline       String?
  depDateTime   DateTime?     // Excel DEP DATE sütunu (local saat)
  arrDateTime   DateTime?     // Excel ARR DATE sütunu (local saat)
  depPort       String?
  arrPort       String?
  crewName      String?       // CREW NAME SURNAME
  rank          String?       // RANK / Duty Type
  nationality   String?
  passportNumber String?
  dateOfBirth   DateTime?
  gender        String?
  status        String?       // STATUS sütunu
  rawData       Json?         // Tüm orijinal kolonlar
  crewMemberId  String?
  crewMember    CrewMember?   @relation(fields: [crewMemberId], references: [id])

  @@index([uploadId])
  @@index([pairingRoute, depDateTime])
}

// Hotel Blokaj modelleri
// Son 2 yükleme saklanır, diff ile karşılaştırılır
model HotelBlockUpload {
  id           String              @id @default(cuid())
  filename     String
  uploadedAt   DateTime            @default(now())
  headers      Json
  reservations HotelBlockReservation[]

  @@index([uploadedAt])
}

model HotelBlockReservation {
  id              String           @id @default(cuid())
  uploadId        String
  upload          HotelBlockUpload @relation(fields: [uploadId], references: [id])
  hotelPort       String?          // Hotel Port
  arrLeg          String?          // Arr Leg
  checkInDate     DateTime?        // Check In Date (GMT+0)
  checkOutDate    DateTime?        // Check Out Date (GMT+0)
  depLeg          String?          // Dep Leg
  singleRoomCount Int?             // Single Room Count W/O Crew -> SNG
  rawData         Json?            // Tüm orijinal kolonlar

  @@index([uploadId])
  @@index([hotelPort, checkInDate])
}
